# 上下文场景感知增强

**让你的 Bot 在群聊中不再"抢答"别人的问题**

---

# ⚠️ 安装后必须配置

## 🚨 必须关闭框架内置的「群聊上下文感知」

**安装本插件后，如果不关闭框架内置功能，会导致：**
- LLM 收到两份群聊记录
- 上下文快速膨胀
- Token 消耗翻倍
- 可能触发上下文溢出

### 关闭方法

**方法一：管理面板**
```
提供商设置 → 群聊上下文感知(原聊天记忆增强) → 关闭「群聊上下文感知增强」开关
```

**方法二：配置文件**
```yaml
provider_ltm_settings:
  group_icl_enable: false  # 必须设为 false！
```

---

## 推荐完整配置

```yaml
# AstrBot 框架配置
provider_ltm_settings:
  group_icl_enable: false  # 关闭框架内置群聊记录
  active_reply:
    enable: true           # 主动回复功能可以保留

provider_settings:
  max_context_length: 20   # 限制对话轮次，防止无限增长
```

---

## 功能对比

| 功能 | 本插件 | 框架内置 LTM |
|------|--------|-------------|
| 记录群聊消息 | ✅ 50条（可配置） | ✅ 300条 |
| **分析对话对象** | ✅ 核心功能 | ❌ |
| **触发类型识别** | ✅ | ❌ |
| **行为指导** | ✅ | ❌ |
| 图像转述 | ✅ 可选 | ✅ |
| 注入位置 | 用户消息 | 系统提示词 |

**本插件可完全替代框架内置 LTM 的群聊记录功能，且功能更强大。**

---

## 解决什么问题？

你的 Bot 是不是经常这样：

- 小明问小红："你吃饭了吗？" → Bot 抢答："我还没吃呢！"
- 群友们在聊天 → Bot 主动插话，还以为别人在问它
- 被主动回复触发后，把所有问题都当成问自己的

**这个插件就是来解决这个问题的。**

---

## 效果

安装后，Bot 会收到这样的场景提示：

```xml
<conversation_scene>
  <trigger type="active">你是主动加入这个对话的，没有人在叫你</trigger>
  <current_message>
    <sender>小明</sender>
    <talking_to>小红</talking_to>
    <content>你吃饭了吗？</content>
  </current_message>
  <instruction>【重要】你是主动加入对话的！小明 正在和 小红 对话，不是在问你。</instruction>
</conversation_scene>
```

| 场景 | 以前 | 现在 |
|------|------|------|
| A 问 B 问题 | Bot 抢答 | Bot 知道不是问自己 |
| @Bot | 正常回复 | 正常回复 |
| 回复 Bot 消息 | 正常回复 | 正常回复 |
| 主动触发 | 以为都在问自己 | 清楚知道谁在和谁说话 |

---

## 插件配置项

### 基础配置

| 配置 | 说明 | 默认值 |
|------|------|--------|
| `enable` | 启用插件 | `true` |
| `bot_names` | Bot 的昵称列表（用于检测被提及） | `[]` |
| `max_history` | 每个群保留的消息数 | `50` |
| `max_groups` | 最大缓存群数（LRU 淘汰） | `100` |
| `dialogue_window` | 注入 LLM 的对话流条数 | `8` |
| `enable_dialogue_flow` | 显示对话流（谁→谁） | `true` |
| `only_group_chat` | 仅群聊生效 | `true` |

### 图像转述配置

| 配置 | 说明 | 默认值 |
|------|------|--------|
| `image_caption` | 启用图像转述 | `false` |
| `image_caption_provider_id` | 图像转述提供商（下拉选择） | 默认提供商 |
| `image_caption_prompt` | 图像转述提示词 | `请用中文简洁描述...` |

**注意**：启用图像转述后，每张图片会调用一次 LLM，会产生额外费用和延迟。

---

## 技术特点

- **内存安全**：LRU 淘汰机制，严格限制消息和会话数量上限
- **高效稳定**：纯规则分析，图像转述为可选功能
- **无侵入性**：只做加法，不修改框架原有信息
- **可持久运行**：无内存泄漏风险

---

## 原理

1. 监听所有群消息，分析 @、回复、上下文推断出"谁在和谁说话"
2. 在 LLM 请求前注入结构化场景描述
3. 告诉 LLM：这条消息是对谁说的、你是被叫的还是主动插话的
4. (可选) 将群友发送的图片转为文字描述

---

**让 Bot 学会"察言观色"，不再尬聊。**

---

本插件开发QQ群：215532038

<img width="400" alt="QQ群二维码" src="https://github.com/user-attachments/assets/113ccf60-044a-47f3-ac8f-432ae05f89ee" />
