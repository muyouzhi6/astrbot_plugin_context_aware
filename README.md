# 上下文场景感知增强

**让你的 Bot 在群聊中不再"抢答"别人的问题**

---

## 解决什么问题？

你的 Bot 是不是经常这样：

- 小明问小红："你吃饭了吗？" → Bot 抢答："我还没吃呢！"
- 群友们在聊天 → Bot 主动插话，还以为别人在问它
- 被主动回复触发后，把所有问题都当成问自己的

**这个插件就是来解决这个问题的。**

---

## ⚠️ 必读：安装后配置

**安装本插件后，必须关闭 AstrBot 内置的「群聊上下文感知」功能，否则会导致上下文重复膨胀！**

### 配置步骤

在 AstrBot 管理面板中：

```
提供商设置 → 群聊上下文感知(原聊天记忆增强) → 关闭「群聊上下文感知增强」开关
```

或在配置文件中设置：

```yaml
provider_ltm_settings:
  group_icl_enable: false  # 必须关闭！
```

### 为什么要关闭？

| 功能 | 本插件 | AstrBot 内置 LTM |
|------|--------|-----------------|
| 记录群聊消息 | ✅ 50条 | ✅ 300条 |
| 分析对话对象 | ✅ | ❌ |
| 触发类型识别 | ✅ | ❌ |
| 注入位置 | 用户消息 | 系统提示词 |

两者同时开启 = LLM 收到两份群聊记录 = 上下文爆炸

### 推荐配置

```yaml
provider_ltm_settings:
  group_icl_enable: false  # 关闭内置 LTM
  active_reply:
    enable: true           # 主动回复可以开

provider_settings:
  max_context_length: 20   # 限制对话轮次，防止无限增长
```

---

## 效果

安装后，Bot 会收到这样的场景提示：

```
当前消息: 小明 → 小红
【重要】小明 正在和 小红 对话，不是在问你！
你是主动加入的，不要把别人的问题当成问你的。
```

| 场景 | 以前 | 现在 |
|------|------|------|
| A 问 B 问题 | Bot 抢答 | Bot 知道不是问自己，选择旁观或补充 |
| @Bot | 正常回复 | 正常回复 |
| 回复 Bot 消息 | 正常回复 | 正常回复 |
| 主动触发 | 以为都在问自己 | 清楚知道谁在和谁说话 |

---

## 插件配置项

| 配置 | 说明 | 默认值 |
|------|------|--------|
| `enable` | 启用插件 | `true` |
| `bot_names` | Bot 的昵称列表，用于检测被提及 | `[]` |
| `max_history` | 每个群保留的消息数 | `50` |
| `max_groups` | 最大缓存群数（LRU 淘汰） | `100` |
| `dialogue_window` | 注入 LLM 的对话流条数 | `8` |
| `enable_dialogue_flow` | 显示对话流（谁→谁） | `true` |
| `only_group_chat` | 仅群聊生效 | `true` |

---

## 原理

纯规则分析，零额外 LLM 调用：

1. 监听所有消息，分析 @、回复、上下文推断出"谁在和谁说话"
2. 在 LLM 请求前注入场景描述
3. 告诉 LLM：这条消息是对谁说的、你是被叫的还是主动插话的

---

**让 Bot 学会"察言观色"，不再尬聊。**

本插件开发QQ群：215532038

<img width="1284" height="2289" alt="qrcode_1767584668806" src="https://github.com/user-attachments/assets/113ccf60-044a-47f3-ac8f-432ae05f89ee" />

